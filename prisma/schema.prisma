// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ================================
// USER MANAGEMENT
// ================================

model User {
  id        String  @id @default(cuid())
  email     String  @unique
  username  String? @unique
  firstName String?
  lastName  String?
  avatar    String?
  bio       String?

  // Authentication
  password         String?
  emailVerified    DateTime?
  isActive         Boolean   @default(true)
  role             UserRole  @default(USER)
  resetToken       String?
  resetTokenExpiry DateTime?

  // Profile info
  dateOfBirth  DateTime?
  gender       Gender?
  height       Float? // in cm
  weight       Float? // in kg
  fitnessLevel Difficulty @default(BEGINNER) // ✅ Changed from FitnessLevel to Difficulty
  goals        String // JSON string for SQLite compatibility
  equipment    String? // JSON string for available equipment from assessment

  // User's primary goal
  primaryGoalId          String?
  hasCompletedAssessment Boolean   @default(false)
  assessmentDate         DateTime?

  // D-S Assessment System
  difficultyLevel Rank?   // D, C, B, A, S level from assessment
  visualRank      String? // Visual rank like "D+", "C-", "B", "A+", "S-"

  // Strength metrics for V3 Routine Generator gating system
  pullUpsMax      Int?    // Max pull-ups without weight
  dipsMax         Int?    // Max dips without weight
  pushUpsMax      Int?    // Max push-ups
  weightedPullUps Float?  // Additional weight in kg for pull-ups
  weightedDips    Float?  // Additional weight in kg for dips
  masteryGoals    String? // JSON array of MasteryGoal (PLANCHE, FRONT_LEVER, etc.)

  // RPG System
  totalXP       Int @default(0) // Total experience points earned
  currentLevel  Int @default(1) // Overall user level
  virtualCoins  Int @default(0) // Virtual currency for rewards
  totalStrength Int @default(0) // Total strength points accumulated from completed skills

  // Streak System
  dailyStreak           Int       @default(0) // Current daily mission streak
  lastDailyCompletedAt  DateTime? // Last time all daily missions were completed

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts               Account[]
  sessions               Session[]
  workoutSessions        WorkoutSession[]
  courseEnrollments      CourseEnrollment[]
  progressEntries        ProgressEntry[]
  posts                  Post[]
  comments               Comment[]
  likes                  Like[]
  achievements           UserAchievement[]
  workoutHistory         WorkoutHistory[]
  dailyMissions          DailyMission[]
  subscriptions          Subscription[]
  userSkills             UserSkill[]
  trainingGoals          TrainingGoal[]
  primaryGoal            TrainingGoal?              @relation("PrimaryGoal", fields: [primaryGoalId], references: [id])
  hexagonProfile         HexagonProfile?
  skillProgress          UserSkillProgress[]
  trainingSessions       TrainingSession[]
  customRoutines         CustomRoutine[]
  favoriteSkillBranches  FavoriteSkillBranch[]
  userBadges             UserBadge[]
  leaderboardEntries     LeaderboardEntry[]
  globalLeaderboard      GlobalLeaderboardEntry[]
  challengeProgress      UserChallengeProgress[]
  progressSnapshots      SkillProgressSnapshot[]
  exerciseCounters       ExerciseCounter[]
  manualExerciseLogs     ManualExerciseLog[]
  dailyRoutines          DailyRoutine[]

  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

// ================================
// ASSESSMENT & PROFILE
// ================================

model HexagonProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Six axes: values normalized 0-10 (for visual display)
  relativeStrength  Float @default(0)
  muscularEndurance Float @default(0)
  balanceControl    Float @default(0)
  jointMobility     Float @default(0)
  bodyTension       Float @default(0)
  skillTechnique    Float @default(0)

  // XP tracking per axis
  relativeStrengthXP  Int @default(0)
  muscularEnduranceXP Int @default(0)
  balanceControlXP    Int @default(0)
  jointMobilityXP     Int @default(0)
  bodyTensionXP       Int @default(0)
  skillTechniqueXP    Int @default(0)

  // Level per axis (BEGINNER/INTERMEDIATE/ADVANCED/ELITE)
  relativeStrengthLevel  String @default("BEGINNER")
  muscularEnduranceLevel String @default("BEGINNER")
  balanceControlLevel    String @default("BEGINNER")
  jointMobilityLevel     String @default("BEGINNER")
  bodyTensionLevel       String @default("BEGINNER")
  skillTechniqueLevel    String @default("BEGINNER")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("hexagon_profiles")
}

// ================================
// WORKOUTS & EXERCISES
// ================================

model Exercise {
  id           String  @id @default(cuid())
  name         String  @unique
  description  String?
  instructions String // JSON string for SQLite compatibility

  // Media
  videoUrl     String?
  imageUrl     String?
  thumbnailUrl String?

  // Exercise details
  category     ExerciseCategory
  difficulty   Difficulty
  // Rank mapping: D→BEGINNER, C+B→INTERMEDIATE, A→ADVANCED, S→ELITE
  rank         Rank?
  muscleGroups String // JSON string for SQLite compatibility
  equipment    String // JSON string for SQLite compatibility

  // Metadata
  duration Int? // in seconds
  calories Int? // estimated calories burned

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  workoutExercises   WorkoutExercise[]
  sessionExercises   SessionExercise[]
  exerciseSkills     ExerciseSkill[]
  manualExerciseLogs ManualExerciseLog[]

  @@map("exercises")
}

model Workout {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Workout details
  difficulty Difficulty
  duration   Int? // estimated duration in minutes
  calories   Int? // estimated calories burned

  // Media
  imageUrl     String?
  thumbnailUrl String?

  // Metadata
  isPublic Boolean @default(true)
  tags     String // JSON string for SQLite compatibility

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  exercises WorkoutExercise[]
  sessions  WorkoutSession[]

  @@map("workouts")
}

model WorkoutExercise {
  id         String @id @default(cuid())
  workoutId  String
  exerciseId String
  order      Int

  // Exercise parameters
  sets     Int?
  reps     Int?
  duration Int? // in seconds
  restTime Int? // in seconds
  weight   Float? // in kg
  notes    String?

  workout  Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([workoutId, exerciseId, order])
  @@map("workout_exercises")
}

// ================================
// WORKOUT SESSIONS & TRACKING
// ================================

model WorkoutSession {
  id        String  @id @default(cuid())
  userId    String
  workoutId String?

  // Session details
  name      String?
  startTime DateTime?
  startedAt DateTime? // For daily routine workout sessions
  endTime   DateTime?
  duration  Int? // actual duration in seconds
  calories  Int? // actual calories burned
  notes     String?

  // Daily routine workout fields
  routineId            String? // ID of the daily routine
  totalDuration        Int? // estimated duration in minutes
  estimatedXP          Int? // estimated XP reward
  estimatedCoins       Int? // estimated coins reward
  routine              String? // Complete routine as JSON
  currentPhaseIndex    Int     @default(0) // Current phase in routine
  currentExerciseIndex Int     @default(0) // Current exercise in phase
  completedExercises   String? // JSON array of completed exercise IDs
  progress             String? // Detailed progress tracking as JSON

  // Completion tracking
  completedAt DateTime? // When the workout was completed
  actualXP    Int? // Actual XP earned
  actualCoins Int? // Actual coins earned

  // Session status
  status SessionStatus @default(IN_PROGRESS)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  workout   Workout?          @relation(fields: [workoutId], references: [id])
  exercises SessionExercise[]
  histories WorkoutHistory[]

  @@map("workout_sessions")
}

model SessionExercise {
  id         String @id @default(cuid())
  sessionId  String
  exerciseId String
  order      Int

  // Performed parameters
  sets      Int?
  reps      Int?
  duration  Int? // in seconds
  weight    Float? // in kg
  notes     String?
  completed Boolean @default(false)

  session  WorkoutSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  exercise Exercise       @relation(fields: [exerciseId], references: [id], onDelete: Cascade)

  @@unique([sessionId, exerciseId, order])
  @@map("session_exercises")
}

// ================================
// COURSES & LEARNING
// ================================

model Course {
  id          String  @id @default(cuid())
  title       String
  description String
  content     String? // Rich text content

  // Course details
  difficulty Difficulty
  duration   Int? // estimated duration in hours
  price      Float? // price in cents

  // Media
  imageUrl     String?
  thumbnailUrl String?
  trailerUrl   String?

  // Course status
  isPublished Boolean @default(false)
  isActive    Boolean @default(true)

  // Metadata
  tags     String // JSON string for SQLite compatibility
  category CourseCategory

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  lessons     Lesson[]
  enrollments CourseEnrollment[]

  @@map("courses")
}

model Lesson {
  id          String  @id @default(cuid())
  courseId    String
  title       String
  description String?
  content     String? // Rich text content
  order       Int

  // Lesson details
  duration Int? // duration in minutes

  // Media
  videoUrl String?
  imageUrl String?

  // Lesson status
  isPublished Boolean @default(false)
  isFree      Boolean @default(false)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  course   Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress LessonProgress[]

  @@unique([courseId, order])
  @@map("lessons")
}

model CourseEnrollment {
  id       String @id @default(cuid())
  userId   String
  courseId String

  // Enrollment details
  enrolledAt  DateTime  @default(now())
  completedAt DateTime?
  progress    Float     @default(0) // percentage 0-100

  // Payment info
  paymentId String?
  amount    Float? // amount paid in cents

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("course_enrollments")
}

model LessonProgress {
  id       String @id @default(cuid())
  userId   String
  lessonId String

  // Progress details
  completed   Boolean   @default(false)
  watchTime   Int       @default(0) // in seconds
  completedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

// ================================
// PROGRESS TRACKING
// ================================

model ProgressEntry {
  id     String @id @default(cuid())
  userId String

  // Progress data
  type  ProgressType
  value Float
  unit  String?
  notes String?

  // Media
  imageUrl String?

  // Timestamps
  date      DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("progress_entries")
}

// ================================
// COMMUNITY & SOCIAL
// ================================

model Post {
  id      String  @id @default(cuid())
  userId  String
  title   String?
  content String

  // Media
  imageUrl String?
  videoUrl String?

  // Post metadata
  category PostCategory?
  tags     String // JSON string for SQLite compatibility

  // Engagement
  likesCount    Int @default(0)
  commentsCount Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  comments Comment[]
  likes    Like[]

  @@map("posts")
}

model Comment {
  id      String @id @default(cuid())
  userId  String
  postId  String
  content String

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model Like {
  id     String @id @default(cuid())
  userId String
  postId String

  // Timestamps
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("likes")
}

// ================================
// GAMIFICATION & ACHIEVEMENTS
// ================================

model Achievement {
  id          String @id @default(cuid())
  name        String @unique
  description String

  // Achievement details
  type   AchievementType
  target Float? // target value to unlock
  unit   String?

  // Chain system
  level                Int     @default(1) // Level in the chain (1-5)
  unlocksAchievementId String? @unique // ID of achievement that gets unlocked when this one is completed
  chainName            String? // Name of the chain (e.g., "Push-up Chain", "Planche Chain")

  // Media
  iconUrl  String?
  badgeUrl String?

  // Metadata
  points Int               @default(0)
  rarity AchievementRarity @default(NOVICE)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  userAchievements   UserAchievement[]
  unlocksAchievement Achievement?      @relation("AchievementChain", fields: [unlocksAchievementId], references: [id])
  unlockedBy         Achievement?      @relation("AchievementChain")

  @@map("achievements")
}

model UserAchievement {
  id            String @id @default(cuid())
  userId        String
  achievementId String

  // Achievement progress
  progress    Float     @default(0)
  completed   Boolean   @default(false)
  completedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
  @@map("user_achievements")
}

model ExerciseCounter {
  id       String @id @default(cuid())
  userId   String
  category String // PUSH, PULL, CORE, BALANCE
  count    Float  @default(0) // Total reps or seconds

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, category])
  @@map("exercise_counters")
}

model ManualExerciseLog {
  id         String   @id @default(cuid())
  userId     String
  exerciseId String?
  category   String // PUSH, PULL, CORE, BALANCE
  name       String // Exercise name

  // Performance data
  reps     Int?
  sets     Int?     @default(1)
  duration Int? // seconds
  notes    String?

  // Rewards earned
  xpEarned    Int @default(0)
  coinsEarned Int @default(0)

  // Timestamps
  loggedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  exercise Exercise? @relation(fields: [exerciseId], references: [id])

  @@map("manual_exercise_logs")
}

// ================================
// WORKOUT COMPLETIONS HISTORY
// ================================

model WorkoutHistory {
  id        String  @id @default(cuid())
  userId    String
  sessionId String?

  // Completion summary
  completedAt DateTime   @default(now())
  difficulty  Difficulty
  streakBonus Int        @default(0)
  xpEarned    Int        @default(0)
  coinsEarned Int        @default(0)

  // Hexagon delta applied on completion (JSON string for SQLite)
  hexagonDelta String
  summary      String?

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  session WorkoutSession? @relation(fields: [sessionId], references: [id])

  @@map("workout_history")
}

// ================================
// DAILY MISSIONS
// ================================

model DailyMission {
  id          String   @id @default(cuid())
  userId      String
  date        DateTime
  type        String
  description String
  target      Int?
  progress    Int      @default(0)
  completed   Boolean  @default(false)
  rewardXP    Int      @default(0)
  rewardCoins Int      @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date, type])
  @@map("daily_missions")
}

// ================================
// SUBSCRIPTIONS & PAYMENTS
// ================================

model Subscription {
  id     String @id @default(cuid())
  userId String

  // Subscription details
  plan   SubscriptionPlan
  status SubscriptionStatus

  // Billing
  stripeCustomerId     String?
  stripeSubscriptionId String?
  stripePriceId        String?

  // Dates
  startDate   DateTime  @default(now())
  endDate     DateTime?
  cancelledAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@map("subscriptions")
}

// ================================
// SKILLS & PROGRESSION SYSTEM
// ================================

model Skill {
  id          String        @id @default(cuid())
  name        String        @unique
  description String?
  category    SkillCategory
  difficulty  Difficulty
  branch      SkillBranch // RPG branch classification

  // Progression requirements
  requiredStrength    Int @default(0) // 0-100 scale
  requiredEndurance   Int @default(0) // 0-100 scale
  requiredFlexibility Int @default(0) // 0-100 scale
  requiredBalance     Int @default(0) // 0-100 scale

  // Strength system for progression
  strengthRequired Int @default(0) // Minimum strength points needed to unlock this skill
  strengthGained   Int @default(1) // Strength points gained when completing this skill

  // RPG System
  xpReward   Int @default(0) // XP awarded when skill is completed
  coinReward Int @default(0) // Virtual coins awarded when skill is completed
  order      Int @default(0) // Order within the branch for progression

  // Mission/Quest requirements
  requiredReps     Int? // Required reps to complete
  requiredDuration Int? // Required duration in seconds
  requiredDays     Int  @default(1) // Required days to demonstrate consistency

  // Visual representation
  iconUrl  String?
  imageUrl String?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  prerequisites   SkillPrerequisite[] @relation("SkillPrerequisites")
  dependentSkills SkillPrerequisite[] @relation("PrerequisiteSkills")
  exerciseSkills  ExerciseSkill[]
  userSkills      UserSkill[]
  trainingGoals   TrainingGoal[]

  @@map("skills")
}

model SkillPrerequisite {
  id             String @id @default(cuid())
  skillId        String
  prerequisiteId String

  skill        Skill @relation("SkillPrerequisites", fields: [skillId], references: [id], onDelete: Cascade)
  prerequisite Skill @relation("PrerequisiteSkills", fields: [prerequisiteId], references: [id], onDelete: Cascade)

  @@unique([skillId, prerequisiteId])
  @@map("skill_prerequisites")
}

model ExerciseSkill {
  id         String @id @default(cuid())
  exerciseId String
  skillId    String

  // How much this exercise contributes to the skill
  strengthContribution    Int @default(0) // 0-100
  enduranceContribution   Int @default(0) // 0-100
  flexibilityContribution Int @default(0) // 0-100
  balanceContribution     Int @default(0) // 0-100

  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  skill    Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([exerciseId, skillId])
  @@map("exercise_skills")
}

model UserSkill {
  id      String @id @default(cuid())
  userId  String
  skillId String

  // User's progress in this skill
  strengthLevel    Int @default(0) // 0-100
  enduranceLevel   Int @default(0) // 0-100
  flexibilityLevel Int @default(0) // 0-100
  balanceLevel     Int @default(0) // 0-100

  // RPG Progress tracking
  currentSets        Int   @default(0) // Current sets completed
  currentReps        Int   @default(0) // Current reps completed
  currentDuration    Int   @default(0) // Current duration in seconds
  daysCompleted      Int   @default(0) // Days with successful completion
  completionProgress Float @default(0.0) // 0.0 to 1.0 completion percentage

  // Skill status
  isUnlocked  Boolean   @default(false)
  unlockedAt  DateTime?
  isCompleted Boolean   @default(false)
  completedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([userId, skillId])
  @@map("user_skills")
}

// ================================
// SKILLS CALIBRATION (Hexagon normalization targets)
// ================================

model SkillsCalibration {
  axis        String   @id
  targetValue Float
  p25         Float?
  p50         Float?
  p75         Float?
  p90         Float?
  samples     Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("skills_calibration")
}

// ================================
// TRAINING GOALS & PROGRAMS
// ================================

model TrainingGoal {
  id     String @id @default(cuid())
  userId String

  // Goal details
  name          String?
  description   String?
  targetSkillId String?

  // New goal system (strength, weight_loss, endurance, etc.)
  goalType           String? // strength, weight_loss, endurance, muscle_mass, health
  targetArea         String? // push, pull, core, balance
  preferredDuration  Int?    // preferred workout duration in minutes

  // Goal parameters
  difficulty     Difficulty?
  estimatedWeeks Int?

  // Progress tracking
  isActive    Boolean   @default(true)
  progress    Float     @default(0) // 0-100 percentage
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                 User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  targetSkill          Skill? @relation(fields: [targetSkillId], references: [id])
  usersWithPrimaryGoal User[] @relation("PrimaryGoal")

  @@map("training_goals")
}

model DailyRoutine {
  id     String @id @default(cuid())
  userId String

  date              DateTime
  difficulty        String // BEGINNER, INTERMEDIATE, ADVANCED, ELITE
  totalDuration     Int // minutes
  estimatedXP       Int
  estimatedCoins    Int
  focusAreas        String // JSON array of UnifiedHexagonAxis
  routine           String // Complete routine as JSON

  completed         Boolean   @default(false)
  completedAt       DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, date])
  @@map("daily_routines")
}

// ================================
// FIG SKILL PROGRESSION & TRAINING
// ================================

model UserSkillProgress {
  id           String   @id @default(cuid())
  userId       String
  skillBranch  String   // Maps to MasteryGoal (HANDSTAND, PLANCHE, etc.)
  currentLevel String   // BEGINNER, INTERMEDIATE, ADVANCED, ELITE

  // Assessment data
  assessmentScore Int      @default(0) // 0-9 points from assessment
  assessmentDate  DateTime @default(now())

  // Progress tracking
  sessionsCompleted Int @default(0)
  totalXPEarned     Int @default(0)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user             User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  trainingSessions TrainingSession[]

  @@unique([userId, skillBranch])
  @@map("user_skill_progress")
}

model TrainingSession {
  id                  String   @id @default(cuid())
  userId              String
  userSkillProgressId String

  // Session details
  skillBranch     String   // Maps to MasteryGoal
  userLevel       String   // Level at time of session creation
  duration        Int      // Duration in minutes (10-120)
  status          String   @default("IN_PROGRESS") // IN_PROGRESS, COMPLETED, CANCELLED

  // Session structure (JSON string for SQLite)
  sessionData     String   // Contains phases, exercises, sets, reps

  // XP reward
  xpAwarded       Int      @default(0)
  hexagonCategory String? // balance, strength, static_holds, core, etc.

  // Timing
  startedAt   DateTime  @default(now())
  completedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user                User                        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userSkillProgress   UserSkillProgress           @relation(fields: [userSkillProgressId], references: [id], onDelete: Cascade)
  exerciseCompletions SessionExerciseCompletion[]

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, status])
  @@map("training_sessions")
}

model SessionExerciseCompletion {
  id                String   @id @default(cuid())
  trainingSessionId String
  exerciseIndex     Int      // Index in the session exercises array
  exerciseName      String
  completed         Boolean  @default(false)
  completedAt       DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  trainingSession TrainingSession @relation(fields: [trainingSessionId], references: [id], onDelete: Cascade)

  @@unique([trainingSessionId, exerciseIndex])
  @@map("session_exercise_completions")
}

// ================================
// ENUMS
// ================================

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum UserRole {
  USER
  PREMIUM
  ADMIN
}

// ✅ UNIFIED: 4 standard difficulty levels across entire system
// Replaces FitnessLevel, Difficulty, and maps to Rank
// BEGINNER (D rank) → Fundamentals & basics
// INTERMEDIATE (C+B ranks) → Building competency  
// ADVANCED (A rank) → Proficient & skilled
// ELITE (S rank) → Mastery & expert level
enum Difficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ELITE
}

enum ExerciseCategory {
  PUSH           // Push exercises (push-ups, dips, etc.)
  PULL           // Pull exercises (pull-ups, rows, etc.)
  CORE           // Core and abs exercises
  SKILL_STATIC   // Static skills (planche, front lever, handstand, etc.)
  LEGS           // Leg exercises (squats, lunges, etc.)
  CARDIO         // Cardio exercises
  BALANCE        // Balance exercises
  MOBILITY       // Mobility exercises
  FLEXIBILITY    // Flexibility and stretching
  WARM_UP        // Warm-up exercises
  COOL_DOWN      // Cool-down exercises
}

// Rank system for fine-grained exercise difficulty
// Maps to unified Difficulty: D→BEGINNER, C+B→INTERMEDIATE, A→ADVANCED, S→ELITE
enum Rank {
  D // BEGINNER level
  C // Lower INTERMEDIATE
  B // Upper INTERMEDIATE
  A // ADVANCED level
  S // ELITE level
}

enum MuscleGroup {
  CHEST
  BACK
  SHOULDERS
  ARMS
  CORE
  LEGS
  GLUTES
  FULL_BODY
}

enum Equipment {
  NONE
  PULL_UP_BAR
  RESISTANCE_BANDS
  DUMBBELLS
  KETTLEBELL
  YOGA_MAT
  FOAM_ROLLER
  MEDICINE_BALL
}

enum SessionStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum CourseCategory {
  BEGINNER_GUIDE
  TECHNIQUE
  NUTRITION
  MOBILITY
  STRENGTH_BUILDING
  ADVANCED_SKILLS
  INJURY_PREVENTION
}

enum ProgressType {
  WEIGHT
  BODY_FAT
  MUSCLE_MASS
  MEASUREMENTS
  PERFORMANCE
  PHOTOS
  CUSTOM
}

enum PostCategory {
  PROGRESS
  QUESTION
  TIP
  MOTIVATION
  ACHIEVEMENT
  GENERAL
}

enum AchievementType {
  WORKOUT_COUNT
  EXERCISE_MASTERY
  STREAK
  PROGRESS_MILESTONE
  COURSE_COMPLETION
  COMMUNITY_ENGAGEMENT
  SPECIAL_EVENT
}

// Achievement rarity levels (aligned with Difficulty)
enum AchievementRarity {
  NOVICE       // Beginner-level achievements
  INTERMEDIATE // Intermediate achievements
  ADVANCED     // Advanced achievements
  ELITE        // Elite achievements
  LEGENDARY    // Special/unique achievements
}

enum SubscriptionPlan {
  FREE
  BASIC
  PREMIUM
  ELITE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  EXPIRED
  PAST_DUE
  INCOMPLETE
}

enum SkillCategory {
  BASIC_MOVEMENTS
  PUSH_MOVEMENTS
  PULL_MOVEMENTS
  CORE_STRENGTH
  LEG_STRENGTH
  FLEXIBILITY
  BALANCE
  ADVANCED_SKILLS
  DYNAMIC_MOVEMENTS
  STATIC_ELEMENTS
}

enum SkillBranch {
  PUSH       // Push branch (Push-ups, Dips, etc.)
  PULL       // Pull branch (Pull-ups, Muscle-ups, etc.)
  CORE       // Core branch (Planks, L-sits, Dragon flags, etc.)
  BALANCE    // Balance/Handstands branch
  LOWER_BODY // Lower body branch (Squats, Pistols, etc.)
  STATICS    // Static elements branch (Planche, Front lever, etc.)
  WARM_UP    // Warm-up and mobility branch
}
// ================================
// CUSTOM ROUTINES SYSTEM
// ================================

model CustomRoutine {
  id          String   @id @default(cuid())
  userId      String
  name        String
  description String?
  exercises   String // JSON: Array of { exerciseId, sets, reps, holdTime, restTime, order }
  difficulty  Difficulty
  goal        String   @default("CUSTOM") // MUSCLE_GAIN, WEIGHT_LOSS, STRENGTH, ENDURANCE, MOBILITY, SKILL_MASTERY, CUSTOM
  estimatedDuration Int // minutes
  isPublic    Boolean  @default(false)
  isFavorite  Boolean  @default(false)
  timesUsed   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("custom_routines")
}

model FavoriteSkillBranch {
  id          String   @id @default(cuid())
  userId      String
  skillBranch String // HANDSTAND, PLANCHE, etc. (MasteryGoal)
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillBranch])
  @@map("favorite_skill_branches")
}

// ================================
// BADGES & ACHIEVEMENTS SYSTEM
// ================================

model Badge {
  id          String   @id @default(cuid())
  name        String
  description String
  iconUrl     String?
  type        BadgeType
  requirement String // JSON: { type, target, skillBranch?, etc. }
  rarity      AchievementRarity @default(NOVICE)
  xpReward    Int      @default(0)
  coinsReward Int      @default(0)
  createdAt   DateTime @default(now())

  userBadges UserBadge[]

  @@map("badges")
}

model UserBadge {
  id          String   @id @default(cuid())
  userId      String
  badgeId     String
  earnedAt    DateTime @default(now())
  progress    Int      @default(0) // For tracking progress towards badge
  isCompleted Boolean  @default(false)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@map("user_badges")
}

enum BadgeType {
  SKILL_COMPLETION      // Complete all levels of a skill
  LEVEL_MASTER         // Reach a specific level in a skill
  SESSIONS_MILESTONE   // Complete N training sessions
  STREAK_ACHIEVEMENT   // Maintain streak for N days
  XP_MILESTONE         // Reach total XP milestone
  SPECIAL_EVENT        // Special event badges
}

// ================================
// LEADERBOARDS SYSTEM
// ================================

model LeaderboardEntry {
  id          String   @id @default(cuid())
  userId      String
  skillBranch String // HANDSTAND, PLANCHE, etc.
  score       Int // Based on: level * 1000 + sessions + (XP / 10)
  rank        Int      @default(0)
  weekStart   DateTime // Start of the week for this entry
  weekEnd     DateTime // End of the week
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, skillBranch, weekStart])
  @@map("leaderboard_entries")
}

model GlobalLeaderboardEntry {
  id        String   @id @default(cuid())
  userId    String
  totalXP   Int
  rank      Int      @default(0)
  weekStart DateTime
  weekEnd   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStart])
  @@map("global_leaderboard_entries")
}

// ================================
// WEEKLY CHALLENGES SYSTEM
// ================================

model WeeklyChallenge {
  id          String   @id @default(cuid())
  title       String
  description String
  type        ChallengeType
  target      Int // e.g., 100 push-ups, 5 training sessions, etc.
  xpReward    Int
  coinsReward Int
  badgeId     String? // Optional badge reward
  weekStart   DateTime
  weekEnd     DateTime
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  userProgress UserChallengeProgress[]

  @@map("weekly_challenges")
}

model UserChallengeProgress {
  id          String   @id @default(cuid())
  userId      String
  challengeId String
  progress    Int      @default(0)
  isCompleted Boolean  @default(false)
  completedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  challenge WeeklyChallenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@map("user_challenge_progress")
}

enum ChallengeType {
  TOTAL_EXERCISES    // Complete N exercises this week
  TRAINING_SESSIONS  // Complete N training sessions
  SPECIFIC_SKILL     // Work on specific skill N times
  XP_TARGET          // Earn N XP this week
  STREAK_MAINTAIN    // Maintain daily streak
  CUSTOM             // Custom challenge
}

// ================================
// PROGRESS TRACKING & CHARTS
// ================================

model SkillProgressSnapshot {
  id          String   @id @default(cuid())
  userId      String
  skillBranch String // HANDSTAND, PLANCHE, etc.
  level       String // BEGINNER, INTERMEDIATE, ADVANCED, ELITE
  sessions    Int
  totalXP     Int
  date        DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("skill_progress_snapshots")
}

